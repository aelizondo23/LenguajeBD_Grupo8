<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLOODCARE - Panel de Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="bg-light">

  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container">
      <a class="navbar-brand" href="#">BLOODCARE</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="registro_donante.html">Registrar Donante</a></li>
          <li class="nav-item"><a class="nav-link" href="registro_donacion.html">Registrar Donación</a></li>
          <li class="nav-item"><a class="nav-link" href="registro_rechazo.html">Registrar Rechazo</a></li>
          <li class="nav-item"><a class="nav-link" href="inventario.html">Inventario</a></li>
          <li class="nav-item"><a class="nav-link" href="estadisticas.html">Estadísticas</a></li>
          <li class="nav-item"><a class="nav-link" href="bitacora.html">Bitácora</a></li>
          <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Cerrar Sesión</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="container mt-5">
    <div class="card p-4 shadow-sm bg-white">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Panel de Control</h2>
        <h5 class="text-muted">Sesión iniciada como: <span id="rolUsuario" class="fw-bold"></span></h5>
      </div>

      <div id="messageContainer" class="alert d-none" role="alert"></div>

      <div id="seccionOperaciones">
        <!-- Donante -->
        <div id="formDonante" style="display:none;" class="mb-4">
          <h4>Registrar Donante</h4>
          <form id="donanteForm">
            <div class="row">
              <div class="col-md-6 mb-2"><input class="form-control" placeholder="ID Donante" id="id_donante" required></div>
              <div class="col-md-6 mb-2"><input class="form-control" placeholder="Nombre" id="nombre" required></div>
              <div class="col-md-6 mb-2"><input class="form-control" placeholder="Apellido" id="apellido" required></div>
              <div class="col-md-6 mb-2"><input class="form-control" placeholder="Dirección" id="direccion" required></div>
              <div class="col-md-6 mb-2"><input class="form-control" type="date" id="fecha_nacimiento" required></div>
              <div class="col-md-6 mb-2"><input class="form-control" placeholder="Sexo (M/F)" id="sexo" required></div>
              <div class="col-md-6 mb-2"><input class="form-control" placeholder="Teléfono" id="telefono"></div>
              <div class="col-md-6 mb-2"><input class="form-control" placeholder="Correo" id="correo"></div>
              <div class="col-md-6 mb-2"><input class="form-control" type="number" placeholder="ID Tipo Sangre" id="id_tipo_sangre" required></div>
            </div>
            <button type="submit" class="btn btn-success mt-2">Registrar Donante</button>
          </form>
        </div>

        <!-- Donación -->
        <div id="formDonacion" style="display:none;" class="mb-4">
          <h4>Registrar Donación</h4>
          <form id="donacionForm">
            <input class="form-control mb-2" placeholder="ID Donante" id="don_id_donante" required>
            <input class="form-control mb-2" placeholder="ID Centro" id="don_id_centro" type="number" required>
            <input class="form-control mb-2" placeholder="Fecha (YYYY-MM-DD)" id="don_fecha" required>
            <input class="form-control mb-2" placeholder="Volumen (ml)" id="don_volumen_ml" type="number" required>
            <input class="form-control mb-2" placeholder="Estado" id="don_estado" required>
            <button type="submit" class="btn btn-success">Registrar Donación</button>
          </form>
        </div>

        <!-- Rechazo -->
        <div id="formRechazo" style="display:none;" class="mb-4">
          <h4>Registrar Rechazo</h4>
          <form id="rechazoForm">
            <input class="form-control mb-2" placeholder="ID Donación" id="rec_id_donacion" type="number" required>
            <input class="form-control mb-2" placeholder="ID Causa Rechazo" id="rec_id_causa" type="number" required>
            <input class="form-control mb-2" placeholder="Observaciones" id="rec_observaciones">
            <button type="submit" class="btn btn-danger">Registrar Rechazo</button>
          </form>
        </div>

        <!-- Inventario -->
        <div id="formInventario" style="display:none;" class="mb-4">
          <h4>Consultar Inventario</h4>
          <button id="btnInventario" class="btn btn-info mb-3">Consultar</button>
          <pre id="inventario" class="bg-light p-3 border rounded"></pre>
        </div>

        <div id="sinAcceso" style="display:none;" class="alert alert-warning">
          No tienes permisos para ver este contenido.
        </div>
      </div>
    </div>
  </main>

  <!-- Pie de página -->
  <footer class="bg-danger text-white text-center py-3 mt-5 fw-bold fs-5">
    © 2025 BLOODCARE. Todos los derechos reservados.
  </footer>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Lógica de la página -->
  <script>
    // ===== Config & helpers =====
    const API = "http://127.0.0.1:5000";

    function parseJwt(t) {
      try { return JSON.parse(atob(t.split('.')[1])); } catch { return null; }
    }
    function getToken() {
      return localStorage.getItem('token') || localStorage.getItem('access_token');
    }
    function getRol(payload) {
      return payload?.rol
          ?? payload?.sub?.rol
          ?? payload?.identity?.rol
          ?? "Sin rol";
    }
    function requireAuth() {
      const t = getToken();
      if (!t) {
        alert('No se encontró el token. Redirigiendo a login.');
        window.location.href = 'login.html';
        throw new Error('No token');
      }
      return t;
    }
    async function authFetch(url, options = {}) {
      const t = getToken();
      const headers = new Headers(options.headers || {});
      if (t) headers.set('Authorization', `Bearer ${t}`);
      if (!headers.has('Content-Type') && options.body) {
        headers.set('Content-Type', 'application/json');
      }
      const res = await fetch(url, { ...options, headers });
      if (res.status === 401) {
        alert('Sesión expirada. Vuelve a iniciar sesión.');
        localStorage.removeItem('token');
        localStorage.removeItem('access_token');
        localStorage.removeItem('usuario');
        window.location.href = 'login.html';
        throw new Error('401 Unauthorized');
      }
      return res;
    }

    function mostrarPorRol(rol) {
      document.getElementById('rolUsuario').textContent = rol;

      // Oculta todo y luego habilita según rol
      ['formDonante', 'formDonacion', 'formRechazo', 'formInventario'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

      // Permisos
      const basicos = ['Técnico', 'Diplomado', 'Microbiólogo', 'Jefatura', 'Admin BD', 'Administrador'];
      if (basicos.includes(rol)) {
        const d1 = document.getElementById('formDonante');
        const d2 = document.getElementById('formDonacion');
        if (d1) d1.style.display = 'block';
        if (d2) d2.style.display = 'block';
      }
      const avanzados = ['Diplomado', 'Microbiólogo', 'Jefatura', 'Admin BD', 'Administrador'];
      if (avanzados.includes(rol)) {
        const r1 = document.getElementById('formRechazo');
        const r2 = document.getElementById('formInventario');
        if (r1) r1.style.display = 'block';
        if (r2) r2.style.display = 'block';
      }
    }

    async function consultarInventario() {
      try {
        const res = await authFetch(`${API}/api/inventario`);
        const data = await res.json();
        document.getElementById('inventario').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('inventario').textContent = 'Error al consultar inventario';
      }
    }

    // ===== Eventos =====
    window.onload = function () {
      const token = requireAuth();               // redirige si no hay sesión
      const payload = parseJwt(token);
      if (!payload) {
        alert('Token inválido. Redirigiendo a login.');
        window.location.href = 'login.html';
        return;
      }
      const rol = getRol(payload);
      document.getElementById('seccionOperaciones').style.display = 'block';
      mostrarPorRol(rol);
    };

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('access_token');
      localStorage.removeItem('usuario');
      window.location.href = 'login.html';
    });

    // Botón inventario (si se usa este panel para consultar)
    const btnInv = document.getElementById('btnInventario');
    if (btnInv) btnInv.addEventListener('click', consultarInventario);
  </script>
</body>
</html>




