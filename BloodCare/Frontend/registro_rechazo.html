<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <title>Gestión de Rechazos - BloodCare</title>
  <style>
    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
    }

    footer {
      margin-top: auto;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }

    main {
      flex: 1;
    }

    .card {
      border: none;
      box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.15s ease-in-out;
    }

    .card:hover {
      box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.15);
    }

    .btn-action {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      margin: 0 0.125rem;
    }

    .table th {
      background-color: #fff;
      border-top: none;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }

    .table td {
      vertical-align: middle;
      border-top: 1px solid #eee;
    }

    .search-container {
      position: relative;
    }

    .search-container i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .search-container input {
      padding-left: 40px;
    }

    .loading-spinner {
      display: none;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #dee2e6;
    }

    .modal-header {
      border-bottom: 1px solid #dee2e6;
      background-color: #fff;
    }

    .modal-footer {
      border-top: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }

    .form-label {
      font-weight: 500;
      color: #495057;
      margin-bottom: 0.5rem;
    }

    .required::after {
      content: " *";
      color: #dc3545;
    }

    .stats-card {
      background: #dc3545;
      color: white;
      border: none;
    }

    .stats-card .card-body {
      padding: 1.5rem;
    }

    .stats-number {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
    }

    .stats-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin: 0;
    }

    .badge-status {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container">
      <a class="navbar-brand" href="#">BLOODCARE</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="registro_donante.html">Gestión de Donantes</a></li>
          <li class="nav-item"><a class="nav-link" href="registro_donacion.html">Registrar Donación</a></li>
          <li class="nav-item"><a class="nav-link active" href="registro_rechazo.html">Registrar Rechazo</a></li>
          <li class="nav-item"><a class="nav-link" href="inventario.html">Inventario</a></li>
          <li class="nav-item"><a class="nav-link" href="estadisticas.html">Estadísticas</a></li>
          <li class="nav-item"><a class="nav-link" href="bitacora.html">Bitácora</a></li>
          <li class="nav-item"><a id="nav-admin" class="nav-link d-none" href="admin_panel.html">Panel Admin</a></li>
          <li class="nav-item"><a id="nav-login" class="nav-link" href="login.html">Login</a></li>
          <li class="nav-item"><a id="nav-logout" class="nav-link d-none" href="#" onclick="logout()">Cerrar Sesión</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main>
    <div class="container-fluid py-4">
      <!-- Alert para mostrar mensajes -->
      <div id="alert-container"></div>

      <!-- Header y estadísticas -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0"><i class="bi bi-x-circle-fill me-2"></i>Gestión de Rechazos</h2>
            <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#rechazoModal" onclick="abrirModalNuevo()">
              <i class="bi bi-plus-circle me-2"></i>Nuevo Rechazo
            </button>
          </div>
        </div>
      </div>

      <!-- Estadística rápida -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card stats-card">
            <div class="card-body text-center">
              <h3 class="stats-number" id="total-rechazos">0</h3>
              <p class="stats-label">Total Rechazos</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros y búsqueda -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="search-container">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="searchInput" placeholder="Buscar por ID de donación o observaciones...">
              </div>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="filterCausa">
                <option value="">Todas las causas</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="filterUsuario">
                <option value="">Todos los usuarios</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de rechazos -->
      <div class="card">
        <div class="card-body">
          <!-- Loading spinner -->
          <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-danger" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <!-- Tabla -->
          <div class="table-responsive" id="tableContainer">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Donación</th>
                  <th>Causa</th>
                  <th>Observaciones</th>
                  <th>Usuario</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody id="rechazosTbody">
              </tbody>
            </table>
          </div>

          <!-- Estado vacío -->
          <div class="empty-state d-none" id="emptyState">
            <i class="bi bi-x-circle"></i>
            <h5>No hay rechazos registrados</h5>
            <p>Comienza agregando el primer rechazo al sistema</p>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rechazoModal" onclick="abrirModalNuevo()">
              <i class="bi bi-plus-circle me-2"></i>Agregar Rechazo
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para registrar/editar rechazo -->
  <div class="modal fade" id="rechazoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">
            <i class="bi bi-plus-circle me-2"></i>Nuevo Rechazo
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="form-rechazo">
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label required">Donación</label>
                <select name="id_donacion" class="form-select" required id="donacionSelect">
                  <option value="">Seleccione una donación</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label required">Causa del Rechazo</label>
                <select name="id_causa" class="form-select" required id="causaSelect">
                  <option value="">Seleccione una causa</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Observaciones</label>
                <textarea name="observaciones" class="form-control" rows="4" placeholder="Ingrese observaciones adicionales..."></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger" id="btnSubmit">
              <span id="btn-text">
                <i class="bi bi-check-lg me-2"></i>Guardar Rechazo
              </span>
              <span id="btn-loading" class="d-none">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Guardando...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación de eliminación -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro de que desea eliminar el rechazo <strong id="deleteRechazoId"></strong>?</p>
          <p class="text-muted small">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="bi bi-trash3 me-2"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-danger text-white text-center py-3 mt-5">
    <div class="container">
      <p class="mb-0 fw-bold fs-5">© 2025 BLOODCARE. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variables globales
    let rechazos = [];
    let donaciones = [];
    let causas = [];
    let usuarios = [];
    let editingId = null;
    const API_BASE = 'http://localhost:5000/api';

    // Inicialización
    document.addEventListener('DOMContentLoaded', function () {
      checkAuth();
      if (checkAuth()) {
        cargarDonaciones();
        cargarCausas();
        cargarRechazos();
        setupEventListeners();
      }
    });

    function checkAuth() {
      const token = localStorage.getItem('token');
      const navLogin = document.getElementById('nav-login');
      const navLogout = document.getElementById('nav-logout');

      if (!token) {
        showAlert('No hay sesión activa. Por favor, inicie sesión.', 'warning');
        navLogin.classList.remove('d-none');
        navLogout.classList.add('d-none');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);
        return false;
      } else {
        navLogin.classList.add('d-none');
        navLogout.classList.remove('d-none');
        return true;
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      showAlert('Sesión cerrada correctamente', 'success');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 1000);
    }

    // Cargar donaciones
    function cargarDonaciones() {
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/donaciones/listar`, true); 
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              donaciones = data || []; 
              
              // Llenar select de donaciones
              const select = document.getElementById('donacionSelect');
              select.innerHTML = '<option value="">Seleccione una donación</option>';
              
              donaciones.forEach(donacion => {
                console.log(donacion)
                const option = document.createElement('option');
                option.value = donacion.id_donacion;
                option.textContent = `Donación #${donacion.id_donacion} - ${donacion.id_donante || 'N/A'}`;
                select.appendChild(option);
              });
            } catch (error) {
              console.error('Error parseando donaciones:', error);
            }
          } else {
            console.error('Error cargando donaciones:', xhr.status);
          }
        }
      };
      
      xhr.send();
    }

    // Cargar causas de rechazo
    function cargarCausas() {
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/causa_rechazo/listar`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              causas = data || [];
              
              // Llenar selects
              const selects = ['causaSelect', 'filterCausa'];
              selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'filterCausa') {
                  select.innerHTML = '<option value="">Todas las causas</option>';
                } else {
                  select.innerHTML = '<option value="">Seleccione una causa</option>';
                }
                
                causas.forEach(causa => {
                  const option = document.createElement('option');
                  option.value = causa.id_causa;
                  option.textContent = causa.descripcion;
                  select.appendChild(option);
                });
              });
            } catch (error) {
              console.error('Error parseando causas:', error);
            }
          } else {
            console.error('Error cargando causas:', xhr.status);
          }
        }
      };
      
      xhr.send();
    }

    // Cargar rechazos
    function cargarRechazos() {
      showLoading(true);
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/rechazo/listar`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          showLoading(false);
          
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              rechazos = data || [];
              renderRechazos();
              updateStats();
              
              const usuariosUnicos = [...new Set(rechazos.map(r => r.usuario_registra))];
              const filterUsuario = document.getElementById('filterUsuario');
              filterUsuario.innerHTML = '<option value="">Todos los usuarios</option>';
              usuariosUnicos.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario;
                option.textContent = usuario;
                filterUsuario.appendChild(option);
              });
              
            } catch (error) {
              console.error('Error parseando rechazos:', error);
              showAlert('Error al procesar los datos de rechazos', 'error');
              rechazos = [];
              renderRechazos();
            }
          } else if (xhr.status === 401) {
            showAlert('Sesión expirada. Redirigiendo al login...', 'warning');
            localStorage.removeItem('token');
            setTimeout(() => window.location.href = 'login.html', 2000);
          } else {
            showAlert(`Error al cargar los rechazos: ${xhr.status} ${xhr.statusText}`, 'error');
            rechazos = [];
            renderRechazos();
          }
        }
      };
      
      xhr.onerror = function() {
        showLoading(false);
        showAlert('Error de conexión al cargar rechazos', 'error');
        rechazos = [];
        renderRechazos();
      };
      
      xhr.send();
    }

    // Renderizar tabla de rechazos
    function renderRechazos(rechazosFiltrados = null) {
      const tbody = document.getElementById('rechazosTbody');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');
      
      const lista = rechazosFiltrados || rechazos;

      if (lista.length === 0) {
        tableContainer.classList.add('d-none');
        emptyState.classList.remove('d-none');
        return;
      }

      tableContainer.classList.remove('d-none');
      emptyState.classList.add('d-none');

      tbody.innerHTML = lista.map(rechazo => {
        return `
          <tr>
            <td><strong>${rechazo.id_rechazo}</strong></td>
            <td><span class="badge bg-primary">#${rechazo.id_donacion}</span></td>
            <td><span class="badge bg-warning text-dark">${rechazo.causa_descripcion || 'N/A'}</span></td>
            <td>${rechazo.observaciones || 'Sin observaciones'}</td>
            <td><i class="bi bi-person me-1"></i>${rechazo.usuario_registra}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary btn-action" onclick="editarRechazo('${rechazo.id_rechazo}')" title="Editar">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger btn-action" onclick="confirmarEliminar('${rechazo.id_rechazo}')" title="Eliminar">
                <i class="bi bi-trash3"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Búsqueda y filtros
      document.getElementById('searchInput').addEventListener('input', filtrarRechazos);
      document.getElementById('filterCausa').addEventListener('change', filtrarRechazos);
      document.getElementById('filterUsuario').addEventListener('change', filtrarRechazos);

      // Formulario
      document.getElementById('form-rechazo').addEventListener('submit', handleSubmit);
    }

    // Filtrar rechazos
    function filtrarRechazos() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const causa = document.getElementById('filterCausa').value;
      const usuario = document.getElementById('filterUsuario').value;

      const filtered = rechazos.filter(rechazo => {
        const matchSearch = !search || 
          rechazo.id_donacion.toString().includes(search) ||
          (rechazo.observaciones && rechazo.observaciones.toLowerCase().includes(search));
        
        const matchCausa = !causa || rechazo.id_causa == causa;
        const matchUsuario = !usuario || rechazo.usuario_registra === usuario;

        return matchSearch && matchCausa && matchUsuario;
      });

      renderRechazos(filtered);
    }

    // Abrir modal para nuevo rechazo
    function abrirModalNuevo() {
      editingId = null;
      document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Rechazo';
      document.getElementById('btn-text').innerHTML = '<i class="bi bi-check-lg me-2"></i>Guardar Rechazo';
      document.getElementById('form-rechazo').reset();
    }

    function editarRechazo(id) {
      const editButtons = document.querySelectorAll('.btn-outline-primary');
      editButtons.forEach(btn => btn.disabled = true);
      
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/rechazo/${id}`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        editButtons.forEach(btn => btn.disabled = false);
        
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const rechazo = JSON.parse(xhr.responseText);
              
              editingId = id;
              document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Rechazo';
              document.getElementById('btn-text').innerHTML = '<i class="bi bi-check-lg me-2"></i>Actualizar Rechazo';
              
              // Llenar formulario
              const form = document.getElementById('form-rechazo');
              form.id_donacion.value = rechazo.id_donacion || '';
              form.id_causa.value = rechazo.id_causa || '';
              form.observaciones.value = rechazo.observaciones || '';
              
              // Mostrar modal
              const modal = new bootstrap.Modal(document.getElementById('rechazoModal'));
              modal.show();
            } catch (error) {
              console.error('Error parseando rechazo:', error);
              showAlert('Error al procesar los datos del rechazo', 'error');
            }
          } else {
            showAlert('Error al cargar los datos del rechazo', 'error');
          }
        }
      };
      
      xhr.onerror = function() {
        editButtons.forEach(btn => btn.disabled = false);
        showAlert('Error de conexión al cargar el rechazo', 'error');
      };
      
      xhr.send();
    }

    function confirmarEliminar(id) {
      document.getElementById('deleteRechazoId').textContent = `#${id}`;
      document.getElementById('confirmDeleteBtn').onclick = () => eliminarRechazo(id);
      
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    }

    function eliminarRechazo(id) {
      const deleteBtn = document.getElementById('confirmDeleteBtn');
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';
      
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('DELETE', `${API_BASE}/rechazo/${id}`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = '<i class="bi bi-trash3 me-2"></i>Eliminar';
          
          if (xhr.status === 200 || xhr.status === 204) {
            showAlert('Rechazo eliminado exitosamente', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            
            cargarRechazos();
          } else {
            showAlert('Error al eliminar el rechazo', 'error');
          }
        }
      };
      
      xhr.onerror = function() {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="bi bi-trash3 me-2"></i>Eliminar';
        showAlert('Error de conexión al eliminar el rechazo', 'error');
      };
      
      xhr.send();
    }

    function handleSubmit(e) {
      e.preventDefault();

      if (!checkAuth()) return;

      const submitBtn = document.getElementById('btnSubmit');
      if (submitBtn.disabled) return;

      const token = localStorage.getItem('token');
      setLoading(true);

      const formData = new FormData(e.target);
      const data = {};

      for (let [key, value] of formData.entries()) {
        data[key] = value.trim();
      }

      
      if (!data.id_donacion || !data.id_causa) {
        showAlert('Por favor complete todos los campos requeridos (*)', 'error');
        setLoading(false);
        return;
      }

      try {
        data.id_donacion = parseInt(data.id_donacion);
        data.id_causa = parseInt(data.id_causa);
      } catch (error) {
        showAlert('Los IDs deben ser numéricos válidos', 'error');
        setLoading(false);
        return;
      }

      const rechazoData = {
        id_donacion: data.id_donacion,
        id_causa: data.id_causa,
        observaciones: data.observaciones || ''
      };

      const method = editingId ? 'PUT' : 'POST';
      const url = editingId ? `${API_BASE}/rechazo/${editingId}` : `${API_BASE}/rechazo/registrar`;

      const xhr = new XMLHttpRequest();
      xhr.open(method, url, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          setLoading(false);
          
          if (xhr.status === 200 || xhr.status === 201) {
            const mensaje = editingId ? 'Rechazo actualizado exitosamente!' : '¡Rechazo registrado exitosamente!';
            showAlert(mensaje, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('rechazoModal'));
            modal.hide();
            cargarRechazos();
          } else {
            let errorMessage = editingId ? 'Error al actualizar rechazo' : 'Error al registrar rechazo';

            if (xhr.status === 401) {
              errorMessage = 'Sesión expirada. Por favor, inicie sesión nuevamente.';
              localStorage.removeItem('token');
              setTimeout(() => window.location.href = 'login.html', 2000);
            } else if (xhr.status === 403) {
              errorMessage = 'No tiene permisos para esta operación';
            } else {
              try {
                const result = JSON.parse(xhr.responseText);
                if (result.error) {
                  errorMessage = result.error;
                }
              } catch (e) {
              }
            }

            showAlert(errorMessage, 'error');
          }
        }
      };
      
      xhr.onerror = function() {
        setLoading(false);
        showAlert('Error de conexión con el servidor', 'error');
      };
      
      xhr.send(JSON.stringify(rechazoData));
    }

    function showAlert(message, type) {
      const alertContainer = document.getElementById('alert-container');
      const alertClass = type === 'success' ? 'alert-success' :
        type === 'error' ? 'alert-danger' :
          type === 'warning' ? 'alert-warning' : 'alert-info';

      alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) {
          alert.remove();
        }
      }, 5000);
    }

    function setLoading(loading) {
      const btnText = document.getElementById('btn-text');
      const btnLoading = document.getElementById('btn-loading');
      const submitBtn = document.getElementById('btnSubmit');

      if (loading) {
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
        submitBtn.disabled = true;
      } else {
        btnText.classList.remove('d-none');
        btnLoading.classList.add('d-none');
        submitBtn.disabled = false;
      }
    }

    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');

      if (show) {
        spinner.style.display = 'flex';
        tableContainer.classList.add('d-none');
        emptyState.classList.add('d-none');
      } else {
        spinner.style.display = 'none';
      }
    }

    function updateStats() {
      document.getElementById('total-rechazos').textContent = rechazos.length;
    }
  </script>
</body>

</html>