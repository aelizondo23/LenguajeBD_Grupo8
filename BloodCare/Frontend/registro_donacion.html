<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <title>Gestión de Donaciones - BloodCare</title>
  <style>
    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
    }

    footer {
      margin-top: auto;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }

    main {
      flex: 1;
    }

    .card {
      border: none;
      box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.15s ease-in-out;
    }

    .card:hover {
      box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.15);
    }

    .btn-action {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      margin: 0 0.125rem;
    }

    .table th {
      background-color: #fff;
      border-top: none;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }

    .table td {
      vertical-align: middle;
      border-top: 1px solid #eee;
    }

    .search-container {
      position: relative;
    }

    .search-container i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .search-container input {
      padding-left: 40px;
    }

    .badge-type {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }

    .loading-spinner {
      display: none;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #dee2e6;
    }

    .modal-header {
      border-bottom: 1px solid #dee2e6;
      background-color: #fff;
    }

    .modal-footer {
      border-top: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }

    .form-label {
      font-weight: 500;
      color: #495057;
      margin-bottom: 0.5rem;
    }

    .required::after {
      content: " *";
      color: #dc3545;
    }

    .stats-card {
      background: #dc3545;
      color: white;
      border: none;
    }

    .stats-card .card-body {
      padding: 1.5rem;
    }

    .stats-number {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
    }

    .stats-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin: 0;
    }

    .componente-card {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 1rem;
      background-color: #f8f9fa;
      margin-bottom: 1rem;
    }

    .estado-badge {
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
    }

    .volumen-info {
      font-weight: bold;
      color: #dc3545;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container">
      <a class="navbar-brand" href="#">BLOODCARE</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="registro_donante.html">Gestión de Donantes</a></li>
          <li class="nav-item"><a class="nav-link active" href="registro_donacion.html">Gestión de Donaciones</a></li>
          <li class="nav-item"><a class="nav-link" href="registro_rechazo.html">Registrar Rechazo</a></li>
          <li class="nav-item"><a class="nav-link" href="inventario.html">Inventario</a></li>
          <li class="nav-item"><a class="nav-link" href="estadisticas.html">Estadísticas</a></li>
          <li class="nav-item"><a class="nav-link" href="bitacora.html">Bitácora</a></li>
          <li class="nav-item"><a id="nav-admin" class="nav-link d-none" href="admin_panel.html">Panel Admin</a></li>
          <li class="nav-item"><a id="nav-login" class="nav-link" href="login.html">Login</a></li>
          <li class="nav-item"><a id="nav-logout" class="nav-link d-none" href="#" onclick="logout()">Cerrar Sesión</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main>
    <div class="container-fluid py-4">
      <!-- Alert para mostrar mensajes -->
      <div id="alert-container"></div>

      <!-- Header y estadísticas -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0"><i class="bi bi-heart-fill me-2"></i>Gestión de Donaciones</h2>
            <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#donacionModal" onclick="abrirModalNueva()">
              <i class="bi bi-plus-circle me-2"></i>Nueva Donación
            </button>
          </div>
        </div>
      </div>

      <!-- Estadísticas rápidas -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card stats-card">
            <div class="card-body text-center">
              <h3 class="stats-number" id="total-donaciones">0</h3>
              <p class="stats-label">Total Donaciones</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card" style="background: #28a745;">
            <div class="card-body text-center">
              <h3 class="stats-number" id="donaciones-activas">0</h3>
              <p class="stats-label">Donaciones Activas</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card" style="background: #ffc107; color: #212529;">
            <div class="card-body text-center">
              <h3 class="stats-number" id="volumen-total">0</h3>
              <p class="stats-label">Volumen Total (ml)</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card" style="background: #17a2b8;">
            <div class="card-body text-center">
              <h3 class="stats-number" id="donaciones-mes">0</h3>
              <p class="stats-label">Donaciones Este Mes</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros y búsqueda -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="search-container">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="searchInput" placeholder="Buscar por ID donante o ID donación...">
              </div>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="filterCentro">
                <option value="">Todos los centros</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="filterEstado">
                <option value="">Todos los estados</option>
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
                <option value="Procesado">Procesado</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control" id="filterFechaDesde" placeholder="Desde">
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control" id="filterFechaHasta" placeholder="Hasta">
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de donaciones -->
      <div class="card">
        <div class="card-body">
          <!-- Loading spinner -->
          <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-danger" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <!-- Tabla -->
          <div class="table-responsive" id="tableContainer">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Donante</th>
                  <th>Centro</th>
                  <th>Fecha</th>
                  <th>Volumen (ml)</th>
                  <th>Estado</th>
                  <th>Componentes</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody id="donacionesTbody">
              </tbody>
            </table>
          </div>

          <!-- Estado vacío -->
          <div class="empty-state d-none" id="emptyState">
            <i class="bi bi-heart"></i>
            <h5>No hay donaciones registradas</h5>
            <p>Comienza agregando tu primera donación al sistema</p>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#donacionModal" onclick="abrirModalNueva()">
              <i class="bi bi-plus-circle me-2"></i>Agregar Donación
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para registrar/editar donación -->
  <div class="modal fade" id="donacionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">
            <i class="bi bi-plus-circle me-2"></i>Nueva Donación
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="form-donacion">
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label required">Donante</label>
                <select name="id_donante" class="form-select" required id="donanteSelect">
                  <option value="">Seleccione un donante</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label required">Centro de Donación</label>
                <select name="id_centro" class="form-select" required id="centroSelect">
                  <option value="">Seleccione</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label required">Fecha de Donación</label>
                <input type="date" name="fecha" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label required">Estado</label>
                <select name="estado" class="form-select" required>
                  <option value="">Seleccione</option>
                  <option value="Activo">Activo</option>
                  <option value="Inactivo">Inactivo</option>
                  <option value="Procesado">Procesado</option>
                </select>
              </div>
            </div>
            
            <!-- Sección de componentes sanguíneos -->
            <div class="componente-card mt-4">
              <h6 class="mb-3"><i class="bi bi-droplet-fill me-2 text-danger"></i>Componentes Sanguíneos</h6>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Glóbulos Rojos (ml)</label>
                  <input type="number" name="globulos_rojos" class="form-control" step="0.1" min="0" placeholder="0.0" onchange="calcularVolumenTotal()">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Plaquetas (ml)</label>
                  <input type="number" name="plaquetas" class="form-control" step="0.1" min="0" placeholder="0.0" onchange="calcularVolumenTotal()">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Plasma (ml)</label>
                  <input type="number" name="plasma" class="form-control" step="0.1" min="0" placeholder="0.0" onchange="calcularVolumenTotal()">
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-info-circle me-2"></i>
                    <div>
                      <strong>Volumen Total:</strong> 
                      <span id="volumenTotalDisplay" class="volumen-info">0 ml</span>
                      <small class="d-block text-muted">Mínimo requerido: 350 ml</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger" id="btnSubmit">
              <span id="btn-text">
                <i class="bi bi-check-lg me-2"></i>Guardar Donación
              </span>
              <span id="btn-loading" class="d-none">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Guardando...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación de eliminación -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro de que desea eliminar la donación <strong id="deleteDonacionId"></strong>?</p>
          <p class="text-muted small">Esta acción no se puede deshacer y eliminará todos los componentes asociados.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="bi bi-trash3 me-2"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-danger text-white text-center py-3 mt-5">
    <div class="container">
      <p class="mb-0 fw-bold fs-5">© 2025 BLOODCARE. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let donaciones = [];
    let centros = [];
    let donantes = [];
    let editingId = null;
    const API_BASE = 'http://localhost:5000/api';

    // Inicialización
    document.addEventListener('DOMContentLoaded', function () {
      if (checkAuth()) {
        cargarCentros();
        cargarDonantes();
        cargarDonaciones();
        setupEventListeners();
      }
    });

    function checkAuth() {
      const token = localStorage.getItem('token');
      const navLogin = document.getElementById('nav-login');
      const navLogout = document.getElementById('nav-logout');

      if (!token) {
        showAlert('No hay sesión activa. Por favor, inicie sesión.', 'warning');
        navLogin.classList.remove('d-none');
        navLogout.classList.add('d-none');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);
        return false;
      } else {
        navLogin.classList.add('d-none');
        navLogout.classList.remove('d-none');
        return true;
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      showAlert('Sesión cerrada correctamente', 'success');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 1000);
    }

    // Cargar donantes
    function cargarDonantes() {
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/donantes/listar`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              donantes = data || [];
              
              // Llenar select de donantes
              const donanteSelect = document.getElementById('donanteSelect');
              donanteSelect.innerHTML = '<option value="">Seleccione un donante</option>';
              
              donantes.forEach(donante => {
                const option = document.createElement('option');
                option.value = donante.id_donante;
                option.textContent = `${donante.id_donante} - ${donante.nombre} ${donante.apellido}`;
                donanteSelect.appendChild(option);
              });
            } catch (error) {
              console.error('Error parseando donantes:', error);
            }
          } else {
            console.error('Error cargando donantes:', xhr.status);
          }
        }
      };
      
      xhr.send();
    }

    // Cargar centros de donación
    function cargarCentros() {
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/admin/centros`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              centros = data || [];
              
              // Llenar selects
              const selects = ['centroSelect', 'filterCentro'];
              selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'filterCentro') {
                  select.innerHTML = '<option value="">Todos los centros</option>';
                } else {
                  select.innerHTML = '<option value="">Seleccione</option>';
                }
                
                centros.forEach(centro => {
                  const option = document.createElement('option');
                  option.value = centro.id_centro;
                  option.textContent = centro.nombre;
                  select.appendChild(option);
                });
              });
            } catch (error) {
              console.error('Error parseando centros:', error);
            }
          } else {
            console.error('Error cargando centros:', xhr.status);
          }
        }
      };
      
      xhr.send();
    }

    // Cargar donaciones
    function cargarDonaciones() {
      showLoading(true);
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/donaciones/listar`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          showLoading(false);
          
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              donaciones = data || [];
              renderDonaciones();
              updateStats();
            } catch (error) {
              console.error('Error parseando donaciones:', error);
              showAlert('Error al procesar los datos de donaciones', 'error');
              donaciones = [];
              renderDonaciones();
            }
          } else if (xhr.status === 401) {
            showAlert('Sesión expirada. Redirigiendo al login...', 'warning');
            localStorage.removeItem('token');
            setTimeout(() => window.location.href = 'login.html', 2000);
          } else {
            showAlert(`Error al cargar las donaciones: ${xhr.status} ${xhr.statusText}`, 'error');
            donaciones = [];
            renderDonaciones();
          }
        }
      };
      
      xhr.send();
    }

    // Renderizar tabla de donaciones
    function renderDonaciones(donacionesFiltradas = null) {
      const tbody = document.getElementById('donacionesTbody');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');
      
      const lista = donacionesFiltradas || donaciones;

      if (lista.length === 0) {
        tableContainer.classList.add('d-none');
        emptyState.classList.remove('d-none');
        return;
      }

      tableContainer.classList.remove('d-none');
      emptyState.classList.add('d-none');

      tbody.innerHTML = lista.map(donacion => {
        const fecha = donacion.fecha ? new Date(donacion.fecha).toLocaleDateString() : 'N/A';
        const estadoBadge = getEstadoBadge(donacion.estado);
        const componentesInfo = getComponentesInfo(donacion.componentes || {});
        console.log(donacion)
        return `
          <tr>
            <td><strong>${donacion.id_donacion}</strong></td>
            <td>${donacion.id_donante}</td>
            <td>${donacion.centro || 'N/A'}</td>
            <td>${fecha}</td>
            <td><span class="volumen-info">${donacion.volumen_ml} ml</span></td>
            <td>${estadoBadge}</td>
            <td>${componentesInfo}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary btn-action" onclick="editarDonacion(${donacion.id_donacion})" title="Editar">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger btn-action" onclick="confirmarEliminar(${donacion.id_donacion})" title="Eliminar">
                <i class="bi bi-trash3"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getEstadoBadge(estado) {
      const badges = {
        'Activo': 'bg-success',
        'Inactivo': 'bg-secondary',
        'Procesado': 'bg-warning text-dark'
      };
      return `<span class="badge ${badges[estado] || 'bg-secondary'}">${estado}</span>`;
    }

    function getComponentesInfo(componentes) {
      const items = [];
      if (componentes.globulos_rojos > 0) items.push(`GR: ${componentes.globulos_rojos}ml`);
      if (componentes.plaquetas > 0) items.push(`PLQ: ${componentes.plaquetas}ml`);
      if (componentes.plasma > 0) items.push(`PLS: ${componentes.plasma}ml`);
      return items.length > 0 ? `<small>${items.join('<br>')}</small>` : 'N/A';
    }

    // Configurar event listeners
    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', filtrarDonaciones);
      document.getElementById('filterCentro').addEventListener('change', filtrarDonaciones);
      document.getElementById('filterEstado').addEventListener('change', filtrarDonaciones);
      document.getElementById('filterFechaDesde').addEventListener('change', filtrarDonaciones);
      document.getElementById('filterFechaHasta').addEventListener('change', filtrarDonaciones);
      document.getElementById('form-donacion').addEventListener('submit', handleSubmit);
    }

    // Calcular volumen total
    function calcularVolumenTotal() {
      const globulosRojos = parseFloat(document.querySelector('input[name="globulos_rojos"]').value) || 0;
      const plaquetas = parseFloat(document.querySelector('input[name="plaquetas"]').value) || 0;
      const plasma = parseFloat(document.querySelector('input[name="plasma"]').value) || 0;
      
      const total = globulosRojos + plaquetas + plasma;
      document.getElementById('volumenTotalDisplay').textContent = `${total} ml`;
      
      // Validar mínimo
      const display = document.getElementById('volumenTotalDisplay');
      if (total < 350 && total > 0) {
        display.className = 'volumen-info text-danger';
      } else {
        display.className = 'volumen-info';
      }
    }

    // Filtrar donaciones
    function filtrarDonaciones() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const centro = document.getElementById('filterCentro').value;
      const estado = document.getElementById('filterEstado').value;
      const fechaDesde = document.getElementById('filterFechaDesde').value;
      const fechaHasta = document.getElementById('filterFechaHasta').value;

      const filtered = donaciones.filter(donacion => {
        const matchSearch = !search || 
          donacion.id_donante.toString().toLowerCase().includes(search) ||
          donacion.id_donacion.toString().toLowerCase().includes(search);
        
        const matchCentro = !centro || donacion.id_centro == centro;
        const matchEstado = !estado || donacion.estado === estado;
        
        let matchFecha = true;
        if (fechaDesde || fechaHasta) {
          const fechaDonacion = new Date(donacion.fecha);
          if (fechaDesde) matchFecha = matchFecha && fechaDonacion >= new Date(fechaDesde);
          if (fechaHasta) matchFecha = matchFecha && fechaDonacion <= new Date(fechaHasta);
        }

        return matchSearch && matchCentro && matchEstado && matchFecha;
      });

      renderDonaciones(filtered);
    }

    // Abrir modal para nueva donación
    function abrirModalNueva() {
      editingId = null;
      document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Donación';
      document.getElementById('btn-text').innerHTML = '<i class="bi bi-check-lg me-2"></i>Guardar Donación';
      document.getElementById('form-donacion').reset();
      calcularVolumenTotal();
    }

    // Editar donación
    function editarDonacion(id) {
      const editButtons = document.querySelectorAll('.btn-outline-primary');
      editButtons.forEach(btn => btn.disabled = true);
      
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `${API_BASE}/donaciones/${id}`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        editButtons.forEach(btn => btn.disabled = false);
        
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const donacion = JSON.parse(xhr.responseText);
              
              editingId = id;
              document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Donación';
              document.getElementById('btn-text').innerHTML = '<i class="bi bi-check-lg me-2"></i>Actualizar Donación';
              
              // Llenar formulario
              const form = document.getElementById('form-donacion');
              form.id_donante.value = donacion.id_donante || '';
              form.id_centro.value = donacion.id_centro || '';
              form.fecha.value = donacion.fecha ? donacion.fecha.replace(' ', 'T').split('T')[0] : '';
              form.estado.value = donacion.estado || '';
              
              // Llenar componentes
              const componentes = donacion.componentes || {};
              form.globulos_rojos.value = componentes.globulos_rojos || 0;
              form.plaquetas.value = componentes.plaquetas || 0;
              form.plasma.value = componentes.plasma || 0;
              
              calcularVolumenTotal();
              
              const modal = new bootstrap.Modal(document.getElementById('donacionModal'));
              modal.show();
            } catch (error) {
              console.error('Error parseando donación:', error);
              showAlert('Error al procesar los datos de la donación', 'error');
            }
          } else {
            showAlert('Error al cargar los datos de la donación', 'error');
          }
        }
      };
      
      xhr.onerror = function() {
        editButtons.forEach(btn => btn.disabled = false);
        showAlert('Error de conexión al cargar la donación', 'error');
      };
      
      xhr.send();
    }

    // Confirmar eliminación
    function confirmarEliminar(id) {
      document.getElementById('deleteDonacionId').textContent = `#${id}`;
      document.getElementById('confirmDeleteBtn').onclick = () => eliminarDonacion(id);
      
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    }

    // Eliminar donación
    function eliminarDonacion(id) {
      const deleteBtn = document.getElementById('confirmDeleteBtn');
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';
      
      const token = localStorage.getItem('token');
      
      const xhr = new XMLHttpRequest();
      xhr.open('DELETE', `${API_BASE}/donaciones/${id}`, true);
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = '<i class="bi bi-trash3 me-2"></i>Eliminar';
          
          if (xhr.status === 200 || xhr.status === 204) {
            showAlert('Donación eliminada exitosamente', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            
            cargarDonaciones();
          } else {
            let errorMessage = 'Error al eliminar la donación';
            try {
              const result = JSON.parse(xhr.responseText);
              if (result.error) {
                errorMessage = result.error;
              }
            } catch (e) {}
            showAlert(errorMessage, 'error');
          }
        }
      };
      
      xhr.onerror = function() {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="bi bi-trash3 me-2"></i>Eliminar';
        showAlert('Error de conexión al eliminar la donación', 'error');
      };
      
      xhr.send();
    }

    // Manejar envío del formulario
    function handleSubmit(e) {
      e.preventDefault();

      if (!checkAuth()) return;

      const submitBtn = document.getElementById('btnSubmit');
      if (submitBtn.disabled) return;

      const token = localStorage.getItem('token');
      setLoading(true);

      const formData = new FormData(e.target);
      const data = {};

      for (let [key, value] of formData.entries()) {
        data[key] = value.trim();
      }

      // Validaciones
      if (!data.id_donante || !data.id_centro || !data.fecha || !data.estado) {
        showAlert('Por favor complete todos los campos requeridos (*)', 'error');
        setLoading(false);
        return;
      }

      // Validar componentes
      const globulosRojos = parseFloat(data.globulos_rojos) || 0;
      const plaquetas = parseFloat(data.plaquetas) || 0;
      const plasma = parseFloat(data.plasma) || 0;
      const volumenTotal = globulosRojos + plaquetas + plasma;

      if (volumenTotal <= 0) {
        showAlert('Debe especificar al menos un componente con valor mayor a 0', 'error');
        setLoading(false);
        return;
      }

      if (volumenTotal < 350) {
        showAlert('El volumen total debe ser de al menos 350 ml', 'error');
        setLoading(false);
        return;
      }

      const donacionData = {
        id_donante: data.id_donante,
        id_centro: parseInt(data.id_centro),
        fecha: data.fecha,
        estado: data.estado,
        componentes: {
          globulos_rojos: globulosRojos,
          plaquetas: plaquetas,
          plasma: plasma
        }
      };

      // Determinar método y URL
      const method = editingId ? 'PUT' : 'POST';
      const url = editingId ? `${API_BASE}/donaciones/editar/${editingId}` : `${API_BASE}/donaciones/registrar`;

      const xhr = new XMLHttpRequest();
      xhr.open(method, url, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          setLoading(false);
          
          if (xhr.status === 200 || xhr.status === 201) {
            const mensaje = editingId ? 'Donación actualizada exitosamente!' : '¡Donación registrada exitosamente!';
            showAlert(mensaje, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('donacionModal'));
            modal.hide();
            cargarDonaciones();
          } else {
            let errorMessage = editingId ? 'Error al actualizar donación' : 'Error al registrar donación';

            if (xhr.status === 401) {
              errorMessage = 'Sesión expirada. Por favor, inicie sesión nuevamente.';
              localStorage.removeItem('token');
              setTimeout(() => window.location.href = 'login.html', 2000);
            } else if (xhr.status === 403) {
              errorMessage = 'No tiene permisos para esta operación';
            } else if (xhr.status === 404) {
              errorMessage = 'El donante especificado no existe';
            } else {
              try {
                const result = JSON.parse(xhr.responseText);
                if (result.error) {
                  errorMessage = result.error;
                }
              } catch (e) {}
            }

            showAlert(errorMessage, 'error');
          }
        }
      };
      
      xhr.onerror = function() {
        setLoading(false);
        showAlert('Error de conexión con el servidor', 'error');
      };
      
      xhr.send(JSON.stringify(donacionData));
    }

    // Actualizar estadísticas
    function updateStats() {
      const totalDonaciones = donaciones.length;
      const donacionesActivas = donaciones.filter(d => d.estado === 'Activo').length;
      const volumenTotal = donaciones.reduce((sum, d) => sum + (d.volumen_ml || 0), 0);
      
      // Donaciones del mes actual
      const fechaActual = new Date();
      const mesActual = fechaActual.getMonth();
      const añoActual = fechaActual.getFullYear();
      
      const donacionesMes = donaciones.filter(d => {
        if (!d.fecha) return false;
        const fechaDonacion = new Date(d.fecha);
        return fechaDonacion.getMonth() === mesActual && fechaDonacion.getFullYear() === añoActual;
      }).length;

      document.getElementById('total-donaciones').textContent = totalDonaciones;
      document.getElementById('donaciones-activas').textContent = donacionesActivas;
      document.getElementById('volumen-total').textContent = volumenTotal.toLocaleString();
      document.getElementById('donaciones-mes').textContent = donacionesMes;
    }

    // Utilidades
    function showAlert(message, type) {
      const alertContainer = document.getElementById('alert-container');
      const alertClass = type === 'success' ? 'alert-success' :
        type === 'error' ? 'alert-danger' :
          type === 'warning' ? 'alert-warning' : 'alert-info';

      alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) {
          alert.remove();
        }
      }, 5000);
    }

    function setLoading(loading) {
      const btnText = document.getElementById('btn-text');
      const btnLoading = document.getElementById('btn-loading');
      const submitBtn = document.getElementById('btnSubmit');

      if (loading) {
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
        submitBtn.disabled = true;
      } else {
        btnText.classList.remove('d-none');
        btnLoading.classList.add('d-none');
        submitBtn.disabled = false;
      }
    }

    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');

      if (show) {
        spinner.style.display = 'flex';
        tableContainer.classList.add('d-none');
        emptyState.classList.add('d-none');
      } else {
        spinner.style.display = 'none';
      }
    }
  </script>
</body>

</html>